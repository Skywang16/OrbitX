# 终端上下文重构需求文档

## 概述

本规范解决了 OrbitX 终端上下文管理系统中发现的关键架构问题。当前实现存在前后端耦合问题，AI 系统无法自主确定终端上下文，依赖前端传递的参数。此次重构将建立清晰的关注点分离，以后端作为终端状态的单一数据源。

## 需求

### 需求 1: 后端活跃终端管理

**用户故事:** 作为 OrbitX 的开发者，我希望后端能够自主跟踪当前活跃的终端，以便 AI 和其他后端服务可以在不依赖前端的情况下访问终端上下文。

#### 验收标准

1. 当用户在前端切换终端标签页时，后端应该收到通知并更新其活跃终端注册表
2. 当后端服务需要活跃终端上下文时，它们应该能够直接查询而无需前端参数
3. 当没有设置活跃终端时，后端应该优雅地处理这种情况并提供适当的默认值
4. 当存在多个终端时，后端应该维护一个清晰的概念，知道哪一个是当前活跃的

### 需求 2: 统一终端上下文服务

**用户故事:** 作为后端服务（AI、Shell 工具等），我希望通过统一接口访问终端上下文，这样我就不需要实现单独的上下文解析逻辑。

#### 验收标准

1. 当任何后端服务需要终端上下文时，它应该使用统一的 TerminalContextService 接口
2. 当通过面板 ID 请求上下文时，服务应该返回完整的终端状态，包括 CWD、shell 类型和命令历史
3. 当请求活跃终端上下文时，服务应该自动解析当前活跃的终端
4. 当终端上下文不可用时，服务应该返回适当的错误状态或默认值

### 需求 3: CWD 的单一数据源

**用户故事:** 作为系统管理员，我希望终端工作目录信息有一个单一的权威来源，这样就不会有同步冲突或数据不一致的问题。

#### 验收标准

1. 当终端 CWD 发生变化时，只有后端 ShellIntegrationManager 应该更新权威状态
2. 当前端需要 CWD 信息时，它应该只订阅后端 CWD 变化事件
3. 当前端通过 OSC 序列检测到 CWD 变化时，它不应该回写到后端
4. 当需要 CWD 信息时，所有消费者应该查询后端作为单一数据源

### 需求 4: AI 上下文独立性

**用户故事:** 作为 AI 系统，我希望在构建提示时能够获取终端上下文而不依赖前端传递的参数，这样我就可以自主工作并更加可靠。

#### 验收标准

1. 当构建 AI 提示时，系统不应该需要来自前端的 currentWorkingDirectory 参数
2. 当 AI 需要终端上下文时，它应该直接查询后端 TerminalContextService
3. 当提供 pane_id 时，AI 系统应该使用它来获取特定的终端上下文
4. 当没有提供 pane_id 时，AI 系统应该使用后端注册表中的活跃终端

### 需求 5: 事件系统整合

**用户故事:** 作为系统维护者，我希望有一个单一、清晰的事件集成路径，这样就不会有重复或冲突的事件处理器。

#### 验收标准

1. 当终端事件发生时，它们应该通过单一的事件集成路径处理
2. 当发出 Tauri 事件时，它们应该来自一个权威来源
3. 当注册事件处理器时，不应该有重复或冲突的处理器
4. 当处理事件时，系统应该维护清晰的审计跟踪

### 需求 6: 向后兼容性

**用户故事:** 作为维护 OrbitX 的开发者，我希望重构能够在可能的情况下保持 API 兼容性，这样现有功能在过渡期间能够继续工作。

#### 验收标准

1. 当现有前端代码调用终端 API 时，它们应该继续工作并显示弃用警告
2. 当引入新 API 时，它们应该被清晰地文档化并优于旧版 API
3. 当必须进行破坏性更改时，它们应该被清晰地文档化并提供迁移路径
4. 当重构完成时，旧版 API 应该被标记为在未来版本中移除

### 需求 7: 错误处理和弹性

**用户故事:** 作为 OrbitX 的用户，我希望系统能够优雅地处理终端上下文错误，这样即使终端状态不一致，应用程序也能保持稳定。

#### 验收标准

1. 当无法确定终端上下文时，系统应该提供合理的默认值
2. 当后端服务无法获取上下文时，它们应该优雅地处理错误而不崩溃
3. 当活跃终端注册表为空时，系统应该适当地处理这种状态
4. 当 CWD 信息过时或缺失时，系统应该尝试刷新或使用回退方案

### 需求 8: 性能和效率

**用户故事:** 作为 OrbitX 的用户，我希望终端上下文操作快速高效，这样应用程序能够保持响应性。

#### 验收标准

1. 当查询终端上下文时，缓存数据的响应时间应该在 10ms 以内
2. 当更新活跃终端状态时，操作应该在 5ms 内完成
3. 当多个服务同时查询上下文时，系统应该高效地处理并发访问
4. 当上下文数据被频繁访问时，系统应该实现适当的缓存策略

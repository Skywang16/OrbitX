# 实现计划

- [-] 1. 完全重构类型定义系统
  - 移除所有 ai-sdk 导入，创建全新的原生类型定义
  - 实现 NativeLLMMessage、NativeLLMRequest、NativeLLMResponse 等核心类型
  - 创建简化的 LLMConfig 和 LLMs 配置类型
  - _需求: 1.1, 1.2, 1.3, 1.4_

- [ ] 2. 重写 LLM 核心服务层
  - 创建 NativeLLMService 类，直接调用 Tauri 命令
  - 完全重构 RetryLanguageModel 类，移除所有 ai-sdk 依赖
  - 实现原生流式数据处理，使用 Channel 进行双向通信
  - _需求: 2.1, 2.2, 5.1, 5.2, 5.3, 5.4_

- [ ] 3. 重构 Agent 模块的 LLM 调用
  - 完全重写 agent/llm.ts 中的所有函数，使用原生类型
  - 重构 callAgentLLM 函数，直接处理原生流式数据
  - 更新工具转换函数，使用 NativeLLMTool 类型
  - 重构 agent/base.ts 中的类型引用和方法签名
  - _需求: 3.1, 3.2, 3.3, 6.1, 6.2, 6.3, 6.4_

- [ ] 4. 重构核心对话和规划系统
  - 重写 core/dialogue/llm.ts，使用原生类型处理对话
  - 重构 core/plan.ts 中的规划器，使用原生消息格式
  - 更新 core/dialogue.ts 中的对话处理逻辑
  - 重构 core/chain.ts 中的工具链处理
  - _需求: 3.1, 3.2, 3.3, 6.1, 6.2_

- [ ] 5. 重构内存和工具系统
  - 重写 memory/index.ts 和 memory/memory.ts，使用原生消息类型
  - 重构所有工具文件，使用 NativeLLMToolCall 类型
  - 更新 tools/wrapper.ts 中的工具包装器
  - 重构 tools/human_interact.ts 和 tools/watch_trigger.ts
  - _需求: 6.1, 6.2, 6.3, 6.4_

- [ ] 6. 更新通用工具和类型系统
  - 重构 common/utils.ts 中的工具转换函数
  - 更新所有类型导出文件，移除 ai-sdk 引用
  - 重构错误处理系统，使用简化的错误类型
  - _需求: 4.1, 4.2, 4.3, 4.4, 7.1, 7.2, 7.3, 7.4_

- [ ] 7. 实现流式数据处理优化
  - 创建高效的流式数据处理器
  - 实现背压处理机制，防止内存溢出
  - 优化 Channel 通信的性能
  - _需求: 5.1, 5.2, 5.3, 5.4, 8.1, 8.2, 8.3, 8.4_

- [ ] 8. 实现错误处理和重试机制
  - 创建简化的错误分类系统
  - 实现智能重试逻辑，支持指数退避
  - 添加模型故障转移机制
  - _需求: 7.1, 7.2, 7.3, 7.4_

- [ ] 9. 清理依赖和导入
  - 移除 package.json 中的所有 ai-sdk 依赖
  - 清理所有文件中的 ai-sdk 导入语句
  - 验证没有遗留的 ai-sdk 引用
  - _需求: 1.1, 1.2, 1.3, 1.4_

- [ ] 10. 编写单元测试
  - 为所有新的原生类型编写类型测试
  - 为 NativeLLMService 编写服务测试
  - 为流式数据处理编写测试
  - 为工具调用系统编写测试
  - _需求: 4.1, 4.2, 4.3, 4.4_

- [ ] 11. 编写集成测试
  - 编写端到端的 LLM 调用测试
  - 编写多模型兼容性测试
  - 编写并发调用测试
  - 编写错误恢复测试
  - _需求: 8.1, 8.2, 8.3, 8.4_

- [ ] 12. 性能验证和优化
  - 对比迁移前后的响应时间
  - 验证内存使用情况
  - 测试高并发场景的性能
  - 优化流式数据的延迟
  - _需求: 8.1, 8.2, 8.3, 8.4_

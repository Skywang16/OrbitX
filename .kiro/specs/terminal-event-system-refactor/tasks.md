# 终端事件系统重构实现计划

## 任务概述

本实现计划将现有的分散式终端事件处理系统重构为基于统一事件总线的现代化架构。所有任务都专注于代码实现，确保前端事件接口保持完全一致，同时实现高性能、高可靠性的事件处理。

## 实现任务

- [-] 1. 创建统一事件总线核心模块
  - 实现 `src-tauri/src/mux/event_bus.rs` 文件，包含 `TerminalEvent` 枚举、`MuxEventBus` 结构体和相关配置
  - 实现基于 Tokio mpsc 的有界队列事件总线
  - 实现背压策略和事件合并逻辑
  - 实现指标收集和监控功能
  - 编写单元测试验证事件总线基本功能
  - _需求: 1.1, 1.2, 1.3, 1.4, 5.1, 5.2, 5.3_

- [ ] 2. 重构终端事件处理器
  - 完全重写 `src-tauri/src/terminal/event_handler.rs` 文件
  - 实现基于 `tauri::async_runtime::spawn` 的单消费者异步任务
  - 实现事件映射逻辑，确保前端事件格式完全一致
  - 实现错误处理和重试机制
  - 实现优雅关闭和生命周期管理
  - 编写单元测试验证事件处理逻辑
  - _需求: 2.1, 2.2, 2.3, 2.4, 2.5, 8.1, 8.2_

- [ ] 3. 创建事件总线状态管理器
  - 实现 `src-tauri/src/mux/event_bus_state.rs` 文件
  - 创建符合 Tauri 状态管理模式的 `EventBusState` 结构体
  - 实现状态初始化、启动和关闭方法
  - 实现与现有状态管理器的集成接口
  - 编写单元测试验证状态管理功能
  - _需求: 7.1, 7.2, 7.3, 11.2_

- [ ] 4. 实现 Tauri 命令接口
  - 创建 `src-tauri/src/mux/commands.rs` 文件
  - 实现 `get_mux_metrics` 命令获取事件总线指标
  - 实现 `reset_mux_metrics` 命令重置指标
  - 实现 `get_event_handler_status` 命令获取处理器状态
  - 遵循现有命令接口的错误处理和日志记录模式
  - 编写单元测试验证命令功能
  - _需求: 5.4, 5.5, 11.3, 11.4_

- [ ] 5. 重构 IoHandler 集成事件总线
  - 修改 `src-tauri/src/mux/io_handler.rs` 文件
  - 将原有的 `notification_sender` 替换为事件总线发送器
  - 重构输出处理逻辑，发送 `TerminalEvent::Output` 事件
  - 保持现有的批处理和性能优化逻辑
  - 实现与 Shell 集成的事件发送
  - 编写单元测试验证 IoHandler 集成
  - _需求: 3.1, 3.2, 4.1, 9.1, 9.2_

- [ ] 6. 重构 BatchProcessor 集成事件总线
  - 修改 `src-tauri/src/mux/batch_processor.rs` 文件
  - 将批处理输出重定向到事件总线
  - 优化批处理策略以配合事件总线的背压控制
  - 实现多终端并发处理的公平调度
  - 保持现有的性能优化特性
  - 编写单元测试验证批处理集成
  - _需求: 3.3, 3.4, 9.3, 9.4_

- [ ] 7. 重构 TerminalMux 集成事件总线
  - 修改 `src-tauri/src/mux/terminal_mux.rs` 文件
  - 移除原有的订阅者模式和通知系统
  - 集成事件总线发送器，发送控制事件
  - 重构面板创建、删除、调整大小等操作的事件发送
  - 实现活跃终端变化事件的发送
  - 简化代码结构，移除不必要的复杂性
  - 编写单元测试验证 TerminalMux 集成
  - _需求: 4.2, 4.3, 4.4, 4.5, 4.6_

- [ ] 8. 集成 Shell Integration 事件
  - 修改相关的 Shell Integration 代码
  - 实现工作目录变化事件的发送
  - 实现 Shell 集成状态变化事件的发送
  - 确保事件时机和数据格式与现有行为一致
  - 编写单元测试验证 Shell Integration 事件
  - _需求: 4.7, 4.8_

- [ ] 9. 更新应用初始化代码
  - 修改 `src-tauri/src/lib.rs` 中的 setup 函数
  - 创建和初始化 `EventBusState`
  - 启动事件总线和事件处理器
  - 移除旧的事件处理初始化代码
  - 实现优雅关闭逻辑，集成到现有的窗口关闭处理
  - 更新状态管理器注册列表
  - _需求: 7.1, 7.2, 7.5, 11.1_

- [ ] 10. 更新前端 TerminalStore 事件监听
  - 修改 `src/stores/Terminal.ts` 中的事件监听逻辑
  - 统一所有终端事件的监听和处理
  - 实现基于 requestAnimationFrame 的更新节流
  - 优化事件处理性能，减少不必要的重渲染
  - 实现错误处理和恢复机制
  - 确保所有现有功能正常工作
  - _需求: 6.1, 6.2, 6.5, 8.3, 9.5_

- [ ] 11. 清理旧代码和依赖
  - 移除 `src-tauri/src/terminal/event_handler.rs` 中的旧实现
  - 清理 `src-tauri/src/mux/terminal_mux.rs` 中的订阅者系统
  - 移除不再使用的 crossbeam_channel 依赖
  - 清理相关的测试代码和注释
  - 更新模块导出和依赖关系
  - _需求: 10.3, 11.1_

- [ ] 12. 实现性能优化
  - 在事件总线中实现智能批处理合并
  - 优化内存使用，实现零拷贝数据传输
  - 实现事件优先级处理，确保控制事件不被丢弃
  - 优化前端事件处理的 CPU 使用
  - 实现自适应背压策略
  - 编写性能测试验证优化效果
  - _需求: 9.1, 9.2, 9.3, 9.4, 9.5_

- [ ] 13. 实现可观测性功能
  - 完善事件总线指标收集系统
  - 实现结构化日志记录
  - 添加错误跟踪和分析功能
  - 实现性能监控和报警
  - 创建调试工具和开发者面板接口
  - 编写监控相关的单元测试
  - _需求: 5.1, 5.2, 5.3, 5.4, 5.5_

- [ ] 14. 实现错误处理和恢复
  - 在事件处理器中实现重试机制
  - 实现事件总线断线重连逻辑
  - 添加降级处理策略
  - 实现前端错误边界和恢复
  - 创建错误报告和诊断工具
  - 编写错误处理相关的单元测试
  - _需求: 8.1, 8.2, 8.3, 8.4, 8.5_

- [ ] 15. 编写集成测试
  - 创建端到端事件流测试
  - 实现多终端并发测试
  - 创建性能压力测试
  - 实现错误场景测试
  - 创建前后端集成测试
  - 验证所有现有功能的正确性
  - _需求: 10.1, 10.2, 10.4, 10.5_

- [ ] 16. 更新文档和注释
  - 更新代码注释，遵循现有的文档风格
  - 创建架构文档说明新的事件流
  - 更新 API 文档
  - 创建故障排除指南
  - 更新开发者文档
  - _需求: 11.5_

- [ ] 17. 最终验证和测试
  - 运行完整的测试套件
  - 验证所有现有终端功能正常工作
  - 进行性能基准测试
  - 验证内存使用和资源清理
  - 进行用户体验测试
  - 确认前端事件接口完全一致
  - _需求: 10.1, 10.2, 10.3, 10.4, 10.5_

## 实现注意事项

### 代码风格要求

- 遵循现有的 Rust 代码风格和命名约定
- 使用 `anyhow::Result` 进行错误处理
- 使用 `tracing` crate 进行日志记录
- 遵循现有的模块结构和组织方式

### 测试要求

- 每个模块都必须包含单元测试
- 测试覆盖率应达到 80% 以上
- 包含错误场景和边界条件测试
- 使用现有的测试工具和框架

### 性能要求

- 事件处理延迟应小于 16ms
- 支持至少 10 个并发终端
- 内存使用应保持在合理范围内
- CPU 使用应优化到最低

### 兼容性要求

- 前端事件名称和格式必须完全一致
- 现有的 Tauri 命令接口不能改变
- 用户配置和设置必须继续有效
- 不能影响现有的功能和用户体验

这个实现计划确保了系统的彻底重构，同时保持了前端接口的完全一致性，为 OrbitX 提供了现代化、高性能的终端事件处理架构。

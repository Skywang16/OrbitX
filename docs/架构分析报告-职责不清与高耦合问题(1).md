# OrbitX æ¶æ„åˆ†ææŠ¥å‘Š - èŒè´£ä¸æ¸…ä¸é«˜è€¦åˆé—®é¢˜

## ğŸ“‹ æ¦‚è¿°

æœ¬æŠ¥å‘ŠåŸºäºå¯¹ OrbitX é¡¹ç›®çš„å…¨é¢ä»£ç å®¡æŸ¥ï¼Œåˆ†æäº†å½“å‰æ¶æ„ä¸­å­˜åœ¨çš„èŒè´£ä¸æ¸…æ™°å’Œé«˜è€¦åˆé—®é¢˜ã€‚é™¤äº†æ‚¨æåˆ°çš„"åç«¯æ´»è·ƒç»ˆç«¯å·¥ä½œç›®å½•è·å–æ¶æ„"é—®é¢˜ï¼Œè¿˜å‘ç°äº†å¤šä¸ªç±»ä¼¼çš„æ¶æ„ç¼ºé™·ã€‚

## ğŸ¯ æ ¸å¿ƒå‘ç°

### é—®é¢˜ä¸¥é‡ç¨‹åº¦åˆ†çº§

- ğŸ”´ **ä¸¥é‡**: å½±å“ç³»ç»Ÿç¨³å®šæ€§å’Œå¯ç»´æŠ¤æ€§
- ğŸŸ¡ **ä¸­ç­‰**: å½±å“å¼€å‘æ•ˆç‡å’Œä»£ç è´¨é‡

---

## ğŸ”´ ä¸¥é‡æ¶æ„é—®é¢˜

### 1. æ´»è·ƒç»ˆç«¯çŠ¶æ€ç®¡ç†èŒè´£æ··ä¹±

**é—®é¢˜æè¿°**:

- **å‰ç«¯**: `useTerminalStore` ç®¡ç† `activeTerminalId`
- **åç«¯**: `TerminalMux` ç®¡ç†ç»ˆç«¯é¢æ¿ï¼Œä½†æ— "æ´»è·ƒç»ˆç«¯"æ¦‚å¿µ
- **AI ç³»ç»Ÿ**: è¢«åŠ¨ä¾èµ–å‰ç«¯ä¼ é€’ `currentWorkingDirectory` å‚æ•°

**ä»£ç è¯æ®**:

```typescript
// å‰ç«¯ AI è°ƒç”¨æ—¶éœ€æ‰‹åŠ¨ä¼ é€’å·¥ä½œç›®å½•
const fullPrompt = await aiApi.buildPromptWithContext(
  currentConversationId.value,
  content,
  userMessageId,
  currentWorkingDirectory // ğŸ‘ˆ æ‰‹åŠ¨ä¼ é€’ï¼ŒèŒè´£ä¸æ˜ç¡®
)
```

```rust
// åç«¯ AI æœåŠ¡è¢«åŠ¨æ¥æ”¶
pub async fn build_prompt_with_tags(
    &self,
    // ...
    current_working_directory: Option<&str>, // ğŸ‘ˆ è¢«åŠ¨ä¾èµ–å‰ç«¯
    // ...
) -> AppResult<String>
```

**å½±å“**:

- AI ç³»ç»Ÿæ— æ³•ä¸»åŠ¨è·å–ç»ˆç«¯ä¸Šä¸‹æ–‡
- å‰åç«¯èŒè´£è¾¹ç•Œæ¨¡ç³Š
- çŠ¶æ€åŒæ­¥å¤æ‚ä¸”æ˜“å‡ºé”™

### 2. ç»ˆç«¯å·¥ä½œç›®å½•ä¿¡æ¯åˆ†æ•£å­˜å‚¨

**é—®é¢˜æè¿°**: å·¥ä½œç›®å½•ä¿¡æ¯åœ¨å¤šä¸ªåœ°æ–¹é‡å¤å­˜å‚¨ï¼Œç¼ºä¹å•ä¸€æ•°æ®æº

**å­˜å‚¨ä½ç½®**:

1. **å‰ç«¯ `TerminalStore`**: `RuntimeTerminalState.cwd`
2. **åç«¯ `TerminalMux`**: `PaneShellState.current_working_directory`
3. **Shell Integration**: åŠ¨æ€è·å–çš„ CWD
4. **Session Store**: æŒä¹…åŒ–çš„ `TerminalState.cwd`

**ä»£ç è¯æ®**:

```typescript
// å‰ç«¯å¤šä¸ªåœ°æ–¹æ›´æ–° CWD
const updateTerminalCwd = (id: string, cwd: string) => {
  const terminal = terminals.value.find(t => t.id === id)
  // ...
  terminal.cwd = cwd
  updateTerminalTitle(terminal, cwd)
  immediateSync() // åŒæ­¥åˆ° Session Store
}
```

```typescript
// Agent è·å–å·¥ä½œç›®å½•éœ€è¦æŸ¥æ‰¾å¤šä¸ªæ•°æ®æº
async getWorkingDirectoryFromTerminal(terminalId?: number): Promise<string | null> {
  // 1. ä» Shell Integration è·å–
  const cwd = await shellIntegrationApi.getPaneCwd(targetTerminalId)
  if (cwd) return cwd

  // 2. ä» Terminal Store è·å–
  const terminal = terminalStore.terminals.find(t => t.backendId === targetTerminalId)
  if (terminal?.cwd && terminal.cwd !== '~') return terminal.cwd
  // ...
}
```

### 3. äº‹ä»¶ç³»ç»Ÿå¾ªç¯ä¾èµ–é£é™©

**é—®é¢˜æè¿°**: å‰åç«¯äº‹ä»¶ä¼ æ’­å­˜åœ¨æ½œåœ¨çš„å¾ªç¯ä¾èµ–

**äº‹ä»¶æµ**:

```
Frontend Terminal Store
    â†“ (updateTerminalCwd)
Session Store
    â†“ (saveSessionState)
Backend Storage
    â†“ (pane_cwd_changed event)
Frontend Terminal Store
    â†“ (å¯èƒ½è§¦å‘æ–°çš„ updateTerminalCwd)
```

**ä»£ç è¯æ®**:

```typescript
// å‰ç«¯ç›‘å¬åç«¯ CWD å˜åŒ–äº‹ä»¶
const unlistenCwdChanged = await listen<{
  paneId: number
  cwd: string
}>('pane_cwd_changed', event => {
  const terminal = findTerminalByBackendId(event.payload.paneId)
  if (terminal) {
    terminal.cwd = event.payload.cwd // å¯èƒ½è§¦å‘æ›´å¤šåŒæ­¥
    updateTerminalTitle(terminal, event.payload.cwd)
  }
})
```

---

## ğŸŸ¡ ä¸­ç­‰æ¶æ„é—®é¢˜

### 4. API å±‚èŒè´£è¿‡åº¦é›†ä¸­

**é—®é¢˜æè¿°**: `AiApi` ç±»æ‰¿æ‹…äº†è¿‡å¤šèŒè´£ï¼Œè¿åå•ä¸€èŒè´£åŸåˆ™

**èŒè´£æ··åˆ**:

- ä¼šè¯ç®¡ç† (Conversations)
- æ¶ˆæ¯ç®¡ç† (Messages)
- æ¨¡å‹é…ç½® (AI Models)
- ä¸Šä¸‹æ–‡æ„å»º (Context Building)
- å¤–éƒ¨æœåŠ¡è°ƒç”¨ (Web Fetch, Code Analysis)

**ä»£ç è¯æ®**:

```typescript
export class AiApi {
  // ä¼šè¯ç®¡ç†
  async createConversation(title?: string) {
    /* ... */
  }
  async getConversations(limit?: number, offset?: number) {
    /* ... */
  }

  // æ¨¡å‹ç®¡ç†
  async getModels(): Promise<AIModelConfig[]> {
    /* ... */
  }
  async addModel(model: Omit<AIModelConfig, 'id'>): Promise<AIModelConfig> {
    /* ... */
  }

  // ä¸Šä¸‹æ–‡æ„å»º
  async buildPromptWithContext(/* ... */) {
    /* ... */
  }

  // å¤–éƒ¨æœåŠ¡
  async analyzeCode(params: AnalyzeCodeParams): Promise<AnalysisResult> {
    /* ... */
  }
  async webFetch(request: WebFetchRequest): Promise<WebFetchResponse> {
    /* ... */
  }
}
```

### 5. çŠ¶æ€åŒæ­¥æœºåˆ¶å¤æ‚

**é—®é¢˜æè¿°**: å¤šä¸ª Store ä¹‹é—´å­˜åœ¨å¤æ‚çš„åŒæ­¥æœºåˆ¶

**åŒæ­¥å…³ç³»**:

- `TerminalStore` â†” `SessionStore`
- `AIChatStore` â†” `SessionStore`
- `ThemeStore` â†” Backend Theme Service
- å¤šä¸ª Store éƒ½è°ƒç”¨ `sessionStore.saveSessionState()`

**ä»£ç è¯æ®**:

```typescript
// Terminal Store ä¸­çš„ç«‹å³åŒæ­¥
const immediateSync = () => {
  syncToSessionStore()
  sessionStore.saveSessionState().catch(() => {})
}

// ç›‘å¬å˜åŒ–å¹¶åŒæ­¥
watch(
  [terminals, activeTerminalId],
  () => {
    immediateSync()
  },
  { deep: true }
)
```

### 6. Backend State ç®¡ç†å±‚æ¬¡æ··ä¹±

**é—®é¢˜æè¿°**: åç«¯çŠ¶æ€ç®¡ç†å™¨åˆå§‹åŒ–é¡ºåºå’Œä¾èµ–å…³ç³»å¤æ‚

**åˆå§‹åŒ–é“¾**:

```
ConfigManagerState
  â†“ (depends on)
ShortcutManagerState
  â†“ (depends on)
StorageCoordinatorState
  â†“ (depends on)
AIManagerState & LLMManagerState
  â†“ (depends on)
ThemeService
```

**ä»£ç è¯æ®**:

```rust
// lib.rs ä¸­å¤æ‚çš„åˆå§‹åŒ–åºåˆ—
let config_state = tauri::async_runtime::block_on(async {
    ConfigManagerState::new().await
})?;
app.manage(config_state);

let shortcut_state = {
    let config_state = app.state::<ConfigManagerState>();  // ä¾èµ–å…³ç³»
    tauri::async_runtime::block_on(async {
        ShortcutManagerState::new(&config_state).await
    })?
};
app.manage(shortcut_state);
// ... æ›´å¤šä¾èµ–é“¾
```

---

---

## ğŸ› ï¸ æ¶æ„é‡æ„å»ºè®®

### 1. å®æ–½æ´»è·ƒç»ˆç«¯çŠ¶æ€åç«¯åŒ–

**ç›®æ ‡**: å°†"æ´»è·ƒç»ˆç«¯"æ¦‚å¿µè¿ç§»åˆ°åç«¯ç®¡ç†

**æ–¹æ¡ˆ**:

```rust
// åç«¯ TerminalMux å¢åŠ æ´»è·ƒç»ˆç«¯ç®¡ç†
impl TerminalMux {
    pub fn set_active_pane(&self, pane_id: PaneId) -> AppResult<()>
    pub fn get_active_pane(&self) -> Option<PaneId>
    pub fn get_active_pane_cwd(&self) -> Option<String>
}
```

**å‰ç«¯ç®€åŒ–**:

```typescript
// AI è°ƒç”¨æ— éœ€æ‰‹åŠ¨ä¼ é€’ CWD
const fullPrompt = await aiApi.buildPromptWithContext(
  currentConversationId.value,
  content,
  userMessageId
  // currentWorkingDirectory ç”±åç«¯è‡ªåŠ¨è·å–
)
```

### 2. å»ºç«‹ç»Ÿä¸€çš„ç»ˆç«¯ä¸Šä¸‹æ–‡æœåŠ¡

**æ¶æ„**:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        Terminal Context Service     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ - getActiveTerminal()               â”‚
â”‚ - getTerminalCwd(terminalId)        â”‚
â”‚ - getTerminalHistory(terminalId)    â”‚
â”‚ - setActiveTerminal(terminalId)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â†“ (ç»Ÿä¸€æ¥å£)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   AI Service    â”‚  Shell Service  â”‚
â”‚                 â”‚                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3. API å±‚è´£ä»»åˆ†ç¦»

**æ‹†åˆ† AiApi**:

```typescript
// ä¼šè¯ç®¡ç†
export class ConversationApi {
  /* ... */
}

// æ¨¡å‹ç®¡ç†
export class ModelConfigApi {
  /* ... */
}

// ä¸Šä¸‹æ–‡æœåŠ¡
export class ContextApi {
  /* ... */
}

// å¤–éƒ¨é›†æˆ
export class IntegrationApi {
  /* ... */
}
```

### 4. ç»Ÿä¸€çŠ¶æ€åŒæ­¥æœºåˆ¶

**å»ºç«‹ State Coordinator**:

```typescript
export class StateCoordinator {
  private stores: Map<string, Store>

  registerStore(name: string, store: Store): void
  syncStates(): Promise<void>
  subscribeToChanges(callback: StateChangeCallback): void
}
```

### 5. ç®€åŒ–åç«¯çŠ¶æ€ç®¡ç†

**ä¾èµ–æ³¨å…¥æ¨¡å¼**:

```rust
pub struct AppStateBuilder {
    config: Option<ConfigManager>,
    storage: Option<StorageCoordinator>,
    // ...
}

impl AppStateBuilder {
    pub fn with_config(mut self, config: ConfigManager) -> Self { /* ... */ }
    pub fn with_storage(mut self, storage: StorageCoordinator) -> Self { /* ... */ }
    pub fn build(self) -> AppResult<AppState> { /* ... */ }
}
```

---

## ğŸ“ˆ å®æ–½ä¼˜å…ˆçº§

### Phase 1: ç´§æ€¥ä¿®å¤ (1-2 å‘¨)

1. **ä¿®å¤æ´»è·ƒç»ˆç«¯çŠ¶æ€ç®¡ç†** - è§£å†³ AI ç³»ç»Ÿä¾èµ–å‰ç«¯ä¼ é€’ CWD çš„é—®é¢˜
2. **å»ºç«‹ç»ˆç«¯ä¸Šä¸‹æ–‡ç»Ÿä¸€æ¥å£** - é¿å…å¤šå¤„é‡å¤æŸ¥æ‰¾å·¥ä½œç›®å½•

### Phase 2: æ¶æ„é‡æ„ (3-4 å‘¨)

1. **API å±‚è´£ä»»åˆ†ç¦»** - æ‹†åˆ†è¿‡å¤§çš„ API ç±»
2. **ç»Ÿä¸€çŠ¶æ€åŒæ­¥æœºåˆ¶** - ç®€åŒ– Store é—´çš„å¤æ‚åŒæ­¥

### Phase 3: ä¼˜åŒ–å®Œå–„ (4-6 å‘¨)

1. **åç«¯çŠ¶æ€ç®¡ç†ç®€åŒ–** - é‡æ„ä¾èµ–æ³¨å…¥å’Œåˆå§‹åŒ–

---

## ğŸ” ç›‘æ§æŒ‡æ ‡

**æ¶æ„å¥åº·åº¦æŒ‡æ ‡**:

- æ¨¡å—é—´ä¾èµ–æ•°é‡
- çŠ¶æ€åŒæ­¥è°ƒç”¨é¢‘ç‡
- äº‹ä»¶ä¼ æ’­è·¯å¾„é•¿åº¦
- API ç±»æ–¹æ³•æ•°é‡

**ç›®æ ‡**:

- å‡å°‘ 50% çš„è·¨å±‚ç›´æ¥è°ƒç”¨
- æ¶ˆé™¤å¾ªç¯ä¾èµ–é£é™©
- ç®€åŒ–çŠ¶æ€åŒæ­¥è·¯å¾„

---

## ğŸ“š å‚è€ƒæ¶æ„æ¨¡å¼

1. **Repository Pattern** - ç»Ÿä¸€æ•°æ®è®¿é—®
2. **Observer Pattern** - è§£è€¦äº‹ä»¶é€šçŸ¥
3. **Facade Pattern** - ç®€åŒ–å­ç³»ç»Ÿæ¥å£
4. **Dependency Injection** - ç®¡ç†ç»„ä»¶ä¾èµ–
5. **Command Pattern** - å°è£…æ“ä½œè¯·æ±‚

---

## ğŸ¯ ç»“è®º

OrbitX å½“å‰æ¶æ„å­˜åœ¨å¤šä¸ªå±‚é¢çš„èŒè´£ä¸æ¸…å’Œé«˜è€¦åˆé—®é¢˜ã€‚æœ€å…³é”®çš„æ˜¯**æ´»è·ƒç»ˆç«¯çŠ¶æ€ç®¡ç†çš„å‰åç«¯èŒè´£æ··ä¹±**ï¼Œè¿™å¯¼è‡´ AI ç³»ç»Ÿæ— æ³•ä¸»åŠ¨è·å–ç»ˆç«¯ä¸Šä¸‹æ–‡ï¼Œå¿…é¡»ä¾èµ–å‰ç«¯æ‰‹åŠ¨ä¼ é€’å‚æ•°ã€‚

é€šè¿‡å®æ–½ä¸Šè¿°é‡æ„å»ºè®®ï¼Œå¯ä»¥æ˜¾è‘—æå‡ç³»ç»Ÿçš„ï¼š

- **å¯ç»´æŠ¤æ€§**: æ¸…æ™°çš„èŒè´£è¾¹ç•Œ
- **å¯æ‰©å±•æ€§**: è§£è€¦çš„ç»„ä»¶è®¾è®¡
- **å¯é æ€§**: å‡å°‘çŠ¶æ€åŒæ­¥é£é™©
- **å¼€å‘æ•ˆç‡**: ç®€åŒ–çš„ä¾èµ–å…³ç³»

å»ºè®®æŒ‰ç…§ä¼˜å…ˆçº§åˆ†é˜¶æ®µå®æ–½ï¼Œç¡®ä¿åœ¨é‡æ„è¿‡ç¨‹ä¸­ç³»ç»Ÿçš„ç¨³å®šæ€§ã€‚

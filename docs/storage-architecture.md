# TermX 存储架构设计文档

## 概述

TermX 采用三层存储架构，通过合理的职责分工实现最佳的性能和用户体验。每种存储技术专注于其最适合的场景。

## 设计原则

- **职责分离**：不同类型的数据使用最适合的存储方式
- **性能优先**：启动速度、运行效率、存储空间的平衡
- **用户友好**：配置可读、状态自动恢复、数据安全
- **扩展性强**：支持未来功能扩展，特别是AI智能化需求

## 架构分层

```
┌─────────────────┐
│   基础配置层     │  ← TOML (用户偏好设置)
├─────────────────┤
│   会话状态层     │  ← MessagePack (快速恢复)
├─────────────────┤
│   智能数据层     │  ← SQLite (AI + 历史数据)
└─────────────────┘
```

## 第一层：TOML 基础配置层

### 职责范围

- **应用外观**：主题、字体、窗口默认设置
- **终端行为**：shell配置、滚动缓冲区、快捷键
- **功能开关**：基础功能的启用/禁用
- **用户偏好**：个人使用习惯设置

### 设计特点

- **人类友好**：可直接编辑的文本格式
- **启动优化**：应用启动时一次性加载
- **安全考虑**：不存储任何敏感信息
- **版本控制**：支持配置文件的备份和同步

### 存储内容示例

- 窗口大小和位置偏好
- 主题和字体选择
- 终端shell和行为设置
- 基础功能开关

## 第二层：MessagePack 会话状态层

### 职责范围

- **窗口状态**：位置、大小、最大化状态
- **标签页管理**：当前打开的标签页和布局
- **终端会话**：每个终端的工作目录和滚动位置
- **应用快照**：实现"关闭啥样，打开啥样"

### 设计特点

- **高效存储**：二进制格式，体积小、速度快
- **完整恢复**：保存应用的完整状态快照
- **实时更新**：应用关闭时自动保存当前状态
- **版本兼容**：支持状态数据的版本管理

### 核心价值

实现无缝的用户体验，用户重新打开应用时能够完全恢复到关闭前的状态，包括所有标签页、工作目录、滚动位置等。

## 第三层：SQLite 智能数据层

### 职责范围

- **AI完整生态**：模型配置、API密钥、功能设置
- **智能历史**：命令历史、AI对话记录
- **数据分析**：使用统计、性能指标
- **搜索引擎**：全文搜索、智能检索

### 设计特点

- **结构化存储**：支持复杂查询和数据关联
- **安全可靠**：事务保证、数据完整性
- **高性能**：索引优化、并发支持
- **扩展性强**：易于添加新功能和数据类型

### 核心价值

作为应用的"智能大脑"，不仅存储历史数据，更重要的是支持AI驱动的智能功能，如自然语言查询、智能推荐等。

## 智能化发展路线

### 当前阶段：基础存储

- **AI配置管理**：模型设置、API密钥安全存储
- **历史数据收集**：命令执行记录、使用统计
- **基础查询**：简单的历史命令搜索

### 未来规划：AI驱动的智能工作空间

#### 自然语言查询（规划中）

用户可以用自然语言查询历史数据：

- "找到上周我用来启动Docker容器的命令"
- "按目录分组查看我最常用的命令"
- "把三个月前部署项目的命令和输出打包发给同事"

#### 智能推荐系统（规划中）

基于历史数据的智能建议：

- 根据当前目录推荐常用命令
- 基于时间模式预测用户需求
- 错误命令的智能纠正建议

#### 工作空间分析（规划中）

深度数据分析功能：

- 工作效率统计和可视化
- 命令使用模式分析
- 项目工作流程优化建议

## 实现策略

### 统一存储管理

通过统一的存储管理器协调三层存储，对外提供简洁的API接口，隐藏底层存储的复杂性。

### 渐进式开发

1. **第一阶段**：建立基础存储架构，解决当前AI配置问题
2. **第二阶段**：完善会话状态恢复，实现无缝用户体验
3. **第三阶段**：开发AI智能功能，构建智能工作空间

### 技术选型理由

- **TOML**：配置文件的标准选择，人类友好
- **MessagePack**：会话状态的最佳格式，高效紧凑
- **SQLite**：AI时代的必然选择，支持复杂查询和自然语言处理

## 文件结构

```
~/Library/Application Support/TerminalApp/  # 或对应平台目录
├── config/
│   └── config.toml          # 基础应用配置 (TOML)
├── themes/                  # 主题文件
│   ├── dark.toml
│   └── light.toml
└── data/                    # 数据文件目录
    ├── termx.db             # SQLite数据库 - AI的完整存储
    │                       #   ├── AI模型配置 (包括API密钥)
    │                       #   ├── AI功能设置
    │                       #   ├── AI聊天历史
    │                       #   ├── 命令历史记录
    │                       #   └── 使用统计数据
    └── session_state.msgpack # 会话状态 (MessagePack)
```

## 性能考虑

### 启动性能

1. **TOML 配置**：启动时一次性加载，缓存在内存
2. **MessagePack 状态**：按需加载，快速反序列化
3. **SQLite 数据**：延迟连接，索引优化查询

### 运行时性能

1. **配置读取**：内存缓存，毫秒级响应
2. **状态保存**：异步写入，不阻塞 UI
3. **历史查询**：索引优化，支持分页

### 存储空间

1. **TOML**：几 KB，可忽略
2. **MessagePack**：几十 KB，压缩高效
3. **SQLite**：随使用增长，支持清理策略

## 实施计划

### 第一阶段：基础架构

- [ ] 实现 TOML 配置管理
- [ ] 解决 AI 模型配置问题
- [ ] 基础的 SQLite 命令历史

### 第二阶段：会话恢复

- [ ] 实现 MessagePack 会话状态
- [ ] 窗口状态恢复
- [ ] 标签页状态恢复

### 第三阶段：AI 查询

- [ ] 完善 SQLite 数据模型
- [ ] 实现自然语言查询
- [ ] 全文搜索优化

### 第四阶段：优化完善

- [ ] 性能优化
- [ ] 数据清理策略
- [ ] 错误恢复机制

## 总结

三层存储架构通过合理的职责分工，实现了最佳的性能和用户体验：

### 存储职责分工

- **config/** - TOML配置文件：基础应用配置（主题、窗口、终端设置）
- **themes/** - 主题文件：用户界面主题和样式配置
- **data/** - 数据文件目录：
  - **SQLite数据库**：AI完整生态 + 历史数据（模型配置、聊天记录、命令历史）
  - **MessagePack文件**：会话状态快照（标签页、工作目录、滚动位置）

### 核心优势

- **AI集中管理**：所有AI相关功能统一在SQLite中，支持复杂查询和自然语言搜索
- **性能最优**：每种存储技术用在最适合的场景
- **安全可靠**：API密钥安全存储，事务保证数据一致性
- **扩展性强**：AI功能扩展只需修改SQLite结构，不影响其他层

这个架构特别适合AI驱动的终端应用，为智能工作空间功能提供了强大的数据基础。

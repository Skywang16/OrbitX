# 类型系统重构方案

## 当前问题

1. 类型定义分散在多个位置，难以维护
2. 存在循环引用问题
3. 重复定义相同类型
4. 缺乏统一的类型导出策略

## 重构方案

### 1. 统一类型结构

```
src/types/
├── index.ts           # 主入口，统一导出所有类型
├── core/              # 核心基础类型
│   ├── index.ts
│   ├── common.ts      # 通用类型
│   └── api.ts         # API通用类型
├── domain/            # 业务领域类型
│   ├── ai.ts          # AI相关类型（合并所有AI类型）
│   ├── terminal.ts    # 终端相关类型
│   ├── storage.ts     # 存储相关类型
│   ├── theme.ts       # 主题相关类型
│   └── ui.ts          # UI相关类型
└── utils/             # 类型工具
    ├── helpers.ts     # 类型辅助函数
    └── guards.ts      # 类型守卫
```

### 2. 循环引用解决策略

#### 方案A：分层依赖

- `core` 层不依赖任何业务类型
- `domain` 层只依赖 `core` 层
- 组件和API只依赖 `domain` 层

#### 方案B：接口分离

- 将循环依赖的接口提取到独立文件
- 使用组合而非继承避免循环

### 3. 具体重构步骤

1. **合并重复类型定义**
   - 将 AI 相关类型合并到 `domain/ai.ts`
   - 统一 `Conversation` 和 `Message` 类型定义
2. **消除循环引用**
   - 重构 `@/eko/types` 和 AI 类型的依赖关系
   - 将共享类型提取到 `core` 层

3. **简化API类型**
   - API 类型文件只保留请求/响应特定格式
   - 业务类型统一从 `domain` 导入

4. **更新导入路径**
   - 统一使用 `@/types` 作为唯一入口
   - 禁止直接导入子模块

### 4. 迁移计划

**阶段1：准备工作**

- 创建新的类型结构
- 合并重复定义

**阶段2：逐步迁移**

- 按模块更新导入路径
- 运行类型检查确保无错误

**阶段3：清理工作**

- 删除旧的分散类型文件
- 更新文档和注释

## 预期收益

- 类型定义集中管理，便于维护
- 消除循环引用，提高编译效率
- 减少重复代码，提高一致性
- 更好的 IDE 支持和自动补全

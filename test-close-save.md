# 应用关闭保存功能测试指南

## 修复内容

### 问题分析
1. **原问题**：应用关闭时没有触发保存
2. **根本原因**：`beforeunload` 事件不能执行异步操作，且在 Tauri 应用中可能不可靠

### 解决方案
使用 Tauri 2.0 的 `onCloseRequested` 事件：

```typescript
// 监听窗口关闭请求事件
const unlisten = await getCurrentWindow().onCloseRequested(async () => {
  console.log('🔄 [应用] 收到窗口关闭请求')
  
  try {
    // 执行保存操作
    await handleAppClose()
    console.log('✅ [应用] 保存完成，允许关闭窗口')
  } catch (error) {
    console.error('❌ [应用] 保存失败，但仍允许关闭:', error)
  }
  
  // 不阻止窗口关闭，让应用正常退出
})
```

## 测试步骤

### 1. 准备测试环境
1. 启动应用：`npm run tauri dev`
2. 打开开发者工具查看控制台日志
3. 创建一些终端会话和状态

### 2. 测试应用关闭保存
1. **创建测试数据**：
   - 创建几个终端标签页
   - 在终端中执行一些命令
   - 修改一些设置

2. **关闭应用**：
   - 点击窗口的关闭按钮 (X)
   - 或使用快捷键 Cmd+Q (macOS) / Alt+F4 (Windows)

3. **观察控制台输出**：
   应该看到类似的日志：
   ```
   🔄 [应用] 收到窗口关闭请求
   🔄 [应用] 开始应用关闭清理...
   ✅ [前端] 会话状态保存成功
   ✅ [应用] 应用关闭清理完成
   ✅ [应用] 保存完成，允许关闭窗口
   ```

4. **重新启动应用**：
   - 重新启动应用
   - 检查是否恢复了之前的终端会话和状态

### 3. 验证保存内容
重启后应该看到：
- ✅ 终端标签页已恢复
- ✅ 工作目录已恢复
- ✅ 命令历史已保存
- ✅ UI 状态已恢复（主题、布局等）

## 技术细节

### onCloseRequested vs beforeunload
- **onCloseRequested**：Tauri 特有的事件，支持异步操作
- **beforeunload**：浏览器事件，不支持异步操作，作为后备方案

### 错误处理
- 如果保存失败，应用仍会关闭，避免用户无法退出
- 提供详细的错误日志便于调试

### 性能考虑
- 保存操作在关闭时执行，不会影响正常使用性能
- 使用 Promise.allSettled 确保所有清理工作都能执行

## 预期结果

修复后，应用关闭时应该：
1. ✅ 自动触发保存操作
2. ✅ 保存所有终端会话状态
3. ✅ 保存 UI 状态和设置
4. ✅ 重启后完整恢复状态
5. ✅ 提供清晰的日志输出

如果测试通过，说明应用关闭保存功能已正常工作。
